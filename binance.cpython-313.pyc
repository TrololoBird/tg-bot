"""Base class for exchange adapters.

Adapters encapsulate all exchangeâ€‘specific logic, translating API
responses into plain Python structures. They must not perform any
business logic; scanning and signal generation belong in the
``scanners`` package. Each method may return ``None`` or raise an
exception if the data could not be retrieved.
"""

from __future__ import annotations

import abc
from datetime import datetime
from typing import List, Dict, Any, Optional


class BaseExchangeAdapter(abc.ABC):
    """Abstract base class for an exchange adapter."""

    def __init__(self, exchange_id: str) -> None:
        self.exchange_id = exchange_id.lower()

    @abc.abstractmethod
    async def list_symbols(self) -> List[str]:
        """Return a list of tradable symbols on this exchange.

        Symbols should be returned in their raw exchange format, e.g.
        ``"BTCUSDT"``. If the exchange has a large number of
        markets, consider returning only a subset (e.g. USDT pairs).
        """
        raise NotImplementedError

    @abc.abstractmethod
    async def fetch_ohlcv(self, symbol: str, timeframe: str, limit: int) -> List[List[Any]]:
        """Fetch OHLCV candles for a symbol.

        The return value must be a list of lists where each inner list
        corresponds to a candle: ``[timestamp, open, high, low, close, volume]``.
        Timestamps should be expressed in milliseconds since the Unix epoch.
        """
        raise NotImplementedError

    @abc.abstractmethod
    async def fetch_ticker(self, symbol: str) -> Optional[Dict[str, Any]]:
        """Fetch a single ticker snapshot for a symbol.

        Returns ``None`` if the symbol is unknown or the data could not
        be retrieved. The returned dict should include at least
        ``last`` or ``close`` and ``quoteVolume`` or ``baseVolume``.
        """
        raise NotImplementedError

    @abc.abstractmethod
    async def fetch_open_interest_history(self, symbol: str, days: int) -> List[Dict[str, Any]]:
        """Fetch open interest history for a symbol.

        Returns a list of dicts with at least ``ts`` (timestamp in
        milliseconds) and ``oi`` (open interest) keys. If the exchange
        does not support open interest, return an empty list.
        """
        raise NotImplementedError